# Copyright 2004 Progeny Linux Systems, Inc.
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
#
# Author: Sam Hart

work_out_mirror() {
    local big_mirror_list=""
    case $ARCH in
        i[3456]86)
            big_mirror_list=$(cat <<EOF
http://mirrors.kernel.org/mandrake/Mandrakelinux/official/10.2/i586/media/main/
http://mirrors.xmission.com/mandrake/official/10.2/i586/media/main/
http://mandrake.mirrors.pair.com/Mandrakelinux/official/10.2/i586/media/main/
http://www.gtlib.gatech.edu/pub/mandrake/official/10.2/i586/media/main/
EOF
            )
            ;;
        *)
            die "Arch $ARCH is unsupported"
            ;;
    esac

    set_mirrors $big_mirror_list
}

work_out_rpms() {
    case $ARCH in
        i[3456]86)
            RPMS=$(cat <<EOF
0:ldconfig-2.3.4-8mdk.i586.rpm
1:sash-3.7-3mdk.i586.rpm
2:common-licenses-1.0-9mdk.noarch.rpm
3:pwdb-conf-0.62-2mdk.i586.rpm
4:libbeecrypt6-3.1.0-5mdk.i586.rpm
5:libtermcap2-2.0.8-36mdk.i586.rpm
6:bash-3.0-2mdk.i586.rpm
7:glibc-2.3.4-8mdk.i586.rpm
8:perl-base-5.8.6-6mdk.i586.rpm
9:zlib1-1.2.2.2-2mdk.i586.rpm
10:chkconfig-1.3.13-3mdk.i586.rpm
11:popt-1.8.3-9mdk.i586.rpm
12:mktemp-1.5-12mdk.i586.rpm
13:libncurses5-5.4-1.20050108.1mdk.i586.rpm
14:libbzip2_1-1.0.2-20mdk.i586.rpm
15:bzip2-1.0.2-20mdk.i586.rpm
16:info-install-4.8-1mdk.i586.rpm
17:gawk-3.1.4-1mdk.i586.rpm
18:perl-MDK-Common-1.1.22-2mdk.i586.rpm
19:libcrack2-2.7-18mdk.i586.rpm
20:shadow-utils-4.0.3-9mdk.i586.rpm
21:setup-2.6-1mdk.i586.rpm
22:libglib2.0_0-2.6.3-1mdk.i586.rpm
23:libselinux1-1.21.11-1mdk.i586.rpm
24:libpwdb0-0.62-2mdk.i586.rpm
25:libuser1-0.53.2-3mdk.i586.rpm
26:ldetect-lst-0.1.82-1mdk.i586.rpm
27:libelfutils1-0.99-1mdk.i586.rpm
28:mount-2.12a-12mdk.i586.rpm
29:ifplugd-0.26-2mdk.i586.rpm
30:iputils-20020927-5mdk.i586.rpm
31:iproute2-2.6.10-1mdk.i586.rpm
32:elfutils-0.99-1mdk.i586.rpm
33:libldetect0.6-0.6.1-1mdk.i586.rpm
34:cracklib-dicts-2.7-18mdk.i586.rpm
35:make-3.80-8mdk.i586.rpm
36:sed-4.1.4-2mdk.i586.rpm
37:diffutils-2.8.7-2mdk.i586.rpm
38:which-2.16-2mdk.i586.rpm
39:findutils-4.2.18-2mdk.i586.rpm
40:psmisc-21.5-3mdk.i586.rpm
41:libmagic1-4.13-1mdk.i586.rpm
42:file-4.13-1mdk.i586.rpm
43:perl-Config-IniFiles-2.38-3mdk.noarch.rpm
44:packdrake-5.0.20-1mdk.i586.rpm
45:libopenssl0.9.7-0.9.7e-5mdk.i586.rpm
46:ethtool-1.8-1mdk.i586.rpm
47:libslang1-1.4.9-6mdk.i586.rpm
48:ifmetric-0.3-3mdk.i586.rpm
49:libdb4.2-4.2.52-6mdk.i586.rpm
50:libusb0.1_4-0.1.8-7mdk.i586.rpm
51:usbutils-0.70-3mdk.i586.rpm
52:unzip-5.51-1mdk.i586.rpm
53:libsasl2-2.1.19-12mdk.i586.rpm
54:mingetty-1.07-3mdk.i586.rpm
55:libiw27-27-1mdk.i586.rpm
56:wireless-tools-27-1mdk.i586.rpm
57:hotplug-2004_09_23-7mdk.i586.rpm
58:libsysfs1-1.2.0-2mdk.i586.rpm
59:sysfsutils-1.2.0-2mdk.i586.rpm
60:libglib1.2-1.2.10-15mdk.i586.rpm
61:libpam0-0.77-27mdk.i586.rpm
62:libintl3-0.14.1-10mdk.i586.rpm
63:gettext-base-0.14.1-10mdk.i586.rpm
64:ncurses-5.4-1.20050108.1mdk.i586.rpm
65:pkgconfig-0.15.0-5mdk.i586.rpm
66:libpcre0-5.0-2mdk.i586.rpm
67:grep-2.5.1a-1mdk.i586.rpm
68:coreutils-5.2.1-5mdk.i586.rpm
69:rpm-helper-0.10-1mdk.noarch.rpm
70:pam-0.77-27mdk.i586.rpm
71:e2fsprogs-1.36-3mdk.i586.rpm
72:libext2fs2-1.36-3mdk.i586.rpm
73:procps-3.2.5-1mdk.i586.rpm
74:libldap2.2_7-2.2.23-5mdk.i586.rpm
75:libuser-0.53.2-3mdk.i586.rpm
76:rmt-0.4b37-2mdk.i586.rpm
77:cpio-2.6-3mdk.i586.rpm
78:rpm-4.2.3-9mdk.i586.rpm
79:modutils-2.4.26-3mdk.i586.rpm
80:sound-scripts-0.25-1mdk.noarch.rpm
81:tar-1.15.1-2mdk.i586.rpm
82:module-init-tools-3.0-7mdk.i586.rpm
83:perl-URPM-1.11-1mdk.i586.rpm
84:util-linux-2.12a-12mdk.i586.rpm
85:SysVinit-2.85-4mdk.i586.rpm
86:initscripts-7.61.1-26mdk.i586.rpm
87:dmidecode-2.6-1mdk.i586.rpm
88:drakxtools-backend-10.2-24mdk.i586.rpm
89:bootloader-utils-1.9-2mdk.i586.rpm
90:udev-054-6mdk.i586.rpm
91:less-382-9mdk.i586.rpm
92:gzip-1.2.4a-14mdk.i586.rpm
93:mkinitrd-4.1.12-9mdk.i586.rpm
94:passwd-0.68-3mdk.i586.rpm
95:kernel-2.6.11.6mdk-1-1mdk.i586.rpm
96:openldap-2.2.23-5mdk.i586.rpm
97:rpmtools-5.0.20-1mdk.i586.rpm
EOF
            )
            ;;
        *)
            # No clue
            die "Unsupported architecture"
            ;;
esac
}

print_rpms() {
    local rpm_list=$(echo "$RPMS" | sed "s/[[:digit:]]\+://")

    echo "RPMs for suite $RPMSUITE and arch $ARCH"
    for a in $rpm_list
    do
        echo " : $a"
    done
}

install_rpms() {
    local rpms_to_get=$(echo "$RPMS" | sed "s/[[:digit:]]\+://")

    echo $rpms_to_get
    echo "Huh?"

    get_rpms $rpms_to_get

    if [ "$DOWNLOAD_ONLY" = "" ]; then
        if [ $(id -u) -ne 0 ]; then
            die "must have root privileges to create chroot"
        fi

        trace "creating chroot directory"
        if [ -e "$TARGET" ]; then
            die "chroot directory $TARGET already exists; aborting"
        fi

        mkdir -p "$TARGET/var/lib/rpm"

        local passnum=0

        cd $PKG_DIR

        while :; do
            trace "Installing pass number $passnum..."
            local pass=$(echo "$RPMS" | grep "^$passnum:" | sed 's/^[0-9]\+://')
            if [ -z "$pass" ]; then
                trace "...nothing left to do."
                break
            else
                set -- $pass

                # make sure each RPM exists
                for RPM; do
                    if [ ! -e "$RPM" ]; then
                        trace "Looking for $RPM"
                        die "cannot find required package $RPM"
                    fi
                done

                # rpm insists on having an absolute path to its --root option's argument
                if ! expr "$TARGET" : "/" >/dev/null 2>&1; then
                    TARGET="$PWD/$TARGET"
                fi
                trace "Installing $* to $TARGET..."
                if ! rpm --install --root "$TARGET" $@; then
                    die "command \"rpm --install --root $TARGET $*\"" \
                    "failed"
                fi
            fi
            passnum=$(( $passnum + 1 ))
        done
        cd $PWD
    fi
}